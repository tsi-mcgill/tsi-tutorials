
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="TSI McGill Tutorials">
      
      
        <meta name="author" content="Stephan O'Brien (stephan.obrien@mcgill.ca)">
      
      
        <link rel="canonical" href="https://github.com/tsi-mcgill/tsi-tutorials/Containerization/containerized_kernels/">
      
      
      
      
      <link rel="icon" href="../../assests/TSI_Logo_Acronym_Alone_Red_Flat.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.4">
    
    
      
        <title>Containerizing Jupyter Kernels - TSI McGill Tutorials</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="sandstone" data-md-color-primary="grey" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#containerizing-jupyter-kernels" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="TSI McGill Tutorials" class="md-header__button md-logo" aria-label="TSI McGill Tutorials" data-md-component="logo">
      
  <img src="../../assests/TSI_Logo_Acronym_Alone_Red_Flat.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            TSI McGill Tutorials
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Containerizing Jupyter Kernels
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="sandstone" data-md-color-primary="grey" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="red" data-md-color-accent="gray"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../Python/" class="md-tabs__link">
        
  
    
  
  Python

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../Cpp/" class="md-tabs__link">
        
  
    
  
  C++

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../Rust/" class="md-tabs__link">
        
  
    
  
  Rust

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../VersionControl/" class="md-tabs__link">
        
  
    
  
  Version Control

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../" class="md-tabs__link">
        
  
    
  
  Containerization

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../Misc/" class="md-tabs__link">
        
  
    
  
  Misc

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="TSI McGill Tutorials" class="md-nav__button md-logo" aria-label="TSI McGill Tutorials" data-md-component="logo">
      
  <img src="../../assests/TSI_Logo_Acronym_Alone_Red_Flat.png" alt="logo">

    </a>
    TSI McGill Tutorials
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Python/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Cpp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C++
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Rust/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../VersionControl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Version Control
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Containerization
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Misc
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="containerizing-jupyter-kernels">Containerizing Jupyter Kernels</h1>
<p>In this tutorial we'll look at how to use a containerized Jupyter kernel.
The first question one might have is why would we want to containerize a Jupyter kernel?
We're often faced with the problem of having complex dependencies that might be difficult to install on ones system.
For example, let's say we're using Windows or Mac OS but one of the packages we want to use is only available for Linux.
We have a few solutions:</p>
<ul>
<li>
<p><b>Dual boot Linux</b>: This is when we split our computer's hard drive in two and install Linux on one side of the hard drive, with the original operating system remaining on the other. A downside of this is that we need to partition our hard drive, reducing the storage available to either partition. This is not something we can do on a shared system such as a high performance computing (HPC) cluster.</p>
</li>
<li>
<p><b>Virtual Machine (VM)</b>: In this setup we'd have a Linux virtual machine set up on the Window's system. This requires a full installation of the guest operating system (Linux), which can use a significant amount of storage space on the host's system. VMs also require resources (e.g. CPU, RAM, GPU) to be allocated to the VM. This means that those resources are no longer available to the host system's scheduler. For example if the VM is allocated 20% of the CPU allocation, and is sitting idle, the host system can only access 80% of the CPU allocation, despite the remaining 20% going unused. The availability of VMs on a shared system will be highly depended on the system.</p>
</li>
<li>
<p><b>100% containerized workflow</b>: With this option, we'd launch Jupyter hub from a container. This isn't a bad solution, but it doesn't allow for swapping between different kernels. Imagine we have a dependency that now only works in Windows and not Linux. We'd have to have two different Jupyter lab instances (one from the host system and one containerized) open to swap between different workflows. This could work in an HPC environment, however an HPC system will likely require such a job by queued in the system as normal job. This may require further layers of ssh-tunneling to go from a login node to an analysis node. HPC clusters which support Jupyter environments (for example <a href="https://docs.alliancecan.ca/wiki/JupyterHub">Digital Research Alliance of Canada</a>) will typically have users interact with their Jupyter instance through a web portal, which uses a python environment based on python versions available on that cluster. </p>
</li>
</ul>
<p>The most promising and flexible solution is to use a containerized workflow.
However, it would be nice if we could use this containerized python environment within the preexisting JupyterHub web portal.
In this tutorial we'll do just that.</p>
<h2 id="apptainer-or-docker">Apptainer or Docker?</h2>
<p>For this tutorial, we'll work in both Apptainer and Docker to show how this can be done using either containerization software.
For one's personal machine, it might be preferable to use Docker.
However, for HPC environments such as DRAC (Narval, Beluga, Cedar, Niagra) we'll use Apptainer.</p>
<h2 id="lets-build-an-image">Let's build an Image</h2>
<p>Let's build a simple small image with installs some python packages from a requirements file.
For this we'll use the Python 3.12-slim image (see <a href="https://hub.docker.com/_/python">DockerHub</a>) as our base image.</p>
<p>We'll use the following <code>requirements.txt</code> file as our requirements:
<div class="highlight"><pre><span></span><code>numpy
matplotlib
scipy
ipykernel
ipython
</code></pre></div></p>
<h3 id="docker-image">Docker image</h3>
<p><div class="highlight"><span class="filename">Dockerfile</span><pre><span></span><code>FROM python:3.12-slim

COPY ./requirements.txt /build/requirements.txt

RUN pip install -r /build/requirements.txt

CMD [&quot;python&quot;]
</code></pre></div>
Which can be built with the tag <code>kernel</code> as:
<div class="highlight"><pre><span></span><code>docker build -t kernel .
</code></pre></div></p>
<h3 id="apptainer-image">Apptainer image</h3>
<p><div class="highlight"><span class="filename">kernel.def</span><pre><span></span><code>Bootstrap: docker
From: python:3.12-slim

%files
    ./requirements.txt /build/requirements.txt

%post
    pip install -r /build/requirements.txt

%runscript
    python
</code></pre></div>
Which can be built to the file <code>kernel.sif</code> as:
<div class="highlight"><pre><span></span><code>apptainer build kernel.sif kernel.def
</code></pre></div></p>
<h2 id="installing-a-custom-kernel">Installing a custom kernel</h2>
<p>Now that we have our image created, let's create a custom Jupyter kernel.
<div class="highlight"><pre><span></span><code>python -m ipykernel install --user --name custom-kernel --display-name=&quot;custom-kernel&quot;
</code></pre></div>
Which installs the kernel in my home directory, e.g.:
<div class="highlight"><pre><span></span><code>Installed kernelspec custom-kernel in /home/obriens/.local/share/jupyter/kernels/custom-kernel
</code></pre></div>
Creating the <code>kernel.json</code> file (<code>/home/obriens/.local/share/jupyter/kernels/custom-kernel/kernel.json</code>):
<div class="highlight"><pre><span></span><code>{
 &quot;argv&quot;: [
  &quot;/home/obriens/miniforge3/bin/python&quot;,
  &quot;-m&quot;,
  &quot;ipykernel_launcher&quot;,
  &quot;-f&quot;,
  &quot;{connection_file}&quot;
 ],
 &quot;display_name&quot;: &quot;custom-kernel&quot;,
 &quot;language&quot;: &quot;python&quot;,
 &quot;metadata&quot;: {
  &quot;debugger&quot;: true
 }
}
</code></pre></div></p>
<p>We want to modify this file with our containerized kernel:</p>
<h3 id="docker">Docker</h3>
<p><div class="highlight"><pre><span></span><code>{
 &quot;argv&quot;: [
     &quot;docker&quot;,
     &quot;run&quot;,
     &quot;--network=host&quot;,
     &quot;--rm&quot;,
     &quot;-v&quot;,
     &quot;{connection_file}:/connection_file&quot;,
     &quot;kernel&quot;,
     &quot;python&quot;,
     &quot;-m&quot;,
     &quot;ipykernel_launcher&quot;,
     &quot;-f&quot;,
     &quot;/connection_file&quot;
 ],
 &quot;display_name&quot;: &quot;custom-kernel (docker)&quot;,
 &quot;language&quot;: &quot;python&quot;,
 &quot;metadata&quot;: {
  &quot;debugger&quot;: true
 }
}
</code></pre></div>
Note that we pass the keyword <code>--network=host</code>, and we're mounting the <code>{connection_file}</code> from the host to <code>/connection_file</code> within the container.</p>
<h3 id="apptainer">Apptainer</h3>
<div class="highlight"><pre><span></span><code>{
 &quot;argv&quot;: [
     &quot;apptainer&quot;,
     &quot;exec&quot;,
     &quot;--bind&quot;,
     &quot;{connection_file}:/tmp/connection_file&quot;,
     &quot;/path/to/kernel.sif&quot;,
     &quot;python&quot;,
     &quot;-m&quot;,
     &quot;ipykernel_launcher&quot;,
     &quot;-f&quot;,
     &quot;/tmp/connection_file&quot;
 ],
 &quot;display_name&quot;: &quot;custom-kernel (apptainer)&quot;,
 &quot;language&quot;: &quot;python&quot;,
 &quot;metadata&quot;: {
  &quot;debugger&quot;: true
 }
}
</code></pre></div>
<p>Note we're binding <code>{connection_file}</code> from the host to <code>/connection_file</code></p>
<h2 id="launching-the-custom-kernel">Launching the custom kernel</h2>
<p>With the image created, the kernel installed and <code>kernel.json</code> modified, we can now launch a Jupyter lab instance and connect to the kernel using (feel free to use any custom options such as the instance port):
<div class="highlight"><pre><span></span><code>jupyter lab
</code></pre></div>
Now we can access the launcher by clicked the "New Launcher" button or pressing Ctrl + Shift + L:</p>
<figure>
<p><img alt="Launch Button" src="../../images/containerized_kernels_launcher.png" width="250" />
  </p>
<figcaption> Launch Button </figcaption>
</figure>
<p>Once pressed, we can see an option to launch a Notebook or Python console using our custom kernel:</p>
<figure>
<p><img alt="Custom kernel" src="../../images/custom_kernel_notebooks.png" width="250" />
  </p>
<figcaption> Custom kernels in Jupyter lab </figcaption>
</figure>
<p>If we're using the Docker kernel, then we can monitor the container using any of the standard methods we'd use for monitoring docker containers, for example:
<div class="highlight"><pre><span></span><code>docker ps
</code></pre></div>
<div class="highlight"><pre><span></span><code>CONTAINER ID   IMAGE                     COMMAND                  CREATED              STATUS              PORTS                                         NAMES
0c39ccf064d0   obriens/kernel:latest     &quot;python -m ipykernel…&quot;   About a minute ago   Up About a minute                                                 determined_chatelet
</code></pre></div>
Or to read the logs of that container:
<div class="highlight"><pre><span></span><code>docker logs 0c39ccf064d0
</code></pre></div>
<div class="highlight"><pre><span></span><code>NOTE: When using the `ipython kernel` entry point, Ctrl-C will not work.

To exit, you will have to explicitly quit this process, by either sending
&quot;quit&quot; from a client, or using Ctrl-\ in UNIX-like environments.

To read more about this, see https://github.com/ipython/ipython/issues/2049


To connect another client to this kernel, use:
    --existing /connection_file
</code></pre></div>
If we shut down the kernel from Jupyter lab (Kernel-&gt;Shut Down All Kernels), you'll notice that the container is deleted upon shut down (<code>docker ps</code>). </p>
<h2 id="some-peculiarities">Some Peculiarities</h2>
<h3 id="number-of-containers">Number of Containers</h3>
<p>If we launch multiple notebooks within Jupyter lab, we'll have multiple containers spawned, for example with 4 notebooks:
<div class="highlight"><pre><span></span><code>docker ps
</code></pre></div>
<div class="highlight"><pre><span></span><code>CONTAINER ID   IMAGE                     COMMAND                  CREATED          STATUS          PORTS                                         NAMES
6830bcd6b669   obriens/kernel:latest     &quot;python -m ipykernel…&quot;   32 seconds ago   Up 31 seconds                                                 competent_zhukovsky
bcec50f54eed   obriens/kernel:latest     &quot;python -m ipykernel…&quot;   34 seconds ago   Up 34 seconds                                                 recursing_noether
c64e9ab35482   obriens/kernel:latest     &quot;python -m ipykernel…&quot;   38 seconds ago   Up 37 seconds                                                 blissful_solomon
20bc592ceb4c   obriens/kernel:latest     &quot;python -m ipykernel…&quot;   41 seconds ago   Up 41 seconds                                                 boring_ardinghelli
</code></pre></div></p>
<p>This might be the desired behavior, however having an individual container for each instance might be very memory and resource consuming. Instead, we could start an instance of some container and then attach any new kernels to that container instead. For this we need to create some "daemon" that will keep the container process alive. Let's modify the <code>Dockerfile</code> to create an infinite process:
<div class="highlight"><pre><span></span><code>FROM python:3.12-slim

COPY ./requirements.txt /build/requirements.txt

RUN pip install -r /build/requirements.txt
RUN echo &quot;#!/bin/bash\nwhile true; do sleep 1; done&quot; &gt;&gt; /build/keep_alive.sh ; chmod a+x /build/keep_alive.sh 

CMD [&quot;/build/keep_alive.sh&quot;]
</code></pre></div></p>
<p>Here we're creating a script called <code>/build/keep_alive.sh</code>. This scrip contains a while loop that will loop <code>while true</code>, i.e. until terminated and then simply sleep for 1 second.</p>
<div class="admonition info">
<p class="admonition-title">Aside on <code>docker stop</code></p>
<p>Note: When running <code>docker stop</code>, Docker will send a <code>SIGTERM</code> signal to the process and wait, by default, 10 seconds before sending a <code>SIGKILL</code> signal. We can keep this in mind when setting the sleep time. If the sleep time is &gt; 10 seconds then the process will be killed. If &lt; 10 seconds then the process will attempt to gracefully terminate. This can help prevent data coruptions by ensuring files are properly closed or clean up any child processes managed by this instance. This is something to keep in mind when designing your image. </p>
</div>
<p>We then set the start script to be <code>/build/keep_alive.sh</code>, so that when we start this container, it will default to this script and run until interrupted.</p>
<p>Next we need to create a start script that we'll call when trying to start/restart a Jupyter kernel:
<div class="highlight"><span class="filename">launch_docker.sh</span><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="c1"># Get the filename of the connection file</span>
<span class="nv">connection_file</span><span class="o">=</span><span class="k">$(</span>basename<span class="w"> </span><span class="nv">$1</span><span class="k">)</span>
<span class="nv">container_name</span><span class="o">=</span><span class="s2">&quot;server&quot;</span>
<span class="nv">image_name</span><span class="o">=</span><span class="s2">&quot;obriens/kernel:latest&quot;</span>

<span class="c1"># Check if the server is currently runnong</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span><span class="w"> </span>docker<span class="w"> </span>container<span class="w"> </span>inspect<span class="w"> </span>-f<span class="w"> </span><span class="s1">&#39;{{.State.Running}}&#39;</span><span class="w"> </span><span class="nv">$container_name</span><span class="w"> </span><span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;true&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Server is running&quot;</span>
<span class="k">else</span>
<span class="w">    </span><span class="c1"># if not then start the server</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Starting the server&quot;</span>
<span class="w">    </span><span class="c1"># Get the path of where the connection files will be stored</span>
<span class="w">    </span><span class="nv">connection_path</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>jupyter<span class="w"> </span>--runtime-dir<span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="c1"># Stop and remove the container if it already exists</span>
<span class="w">    </span>docker<span class="w"> </span>stop<span class="w"> </span><span class="nv">$container_name</span>
<span class="w">    </span>docker<span class="w"> </span>rm<span class="w"> </span><span class="nv">$container_name</span>
<span class="w">    </span><span class="c1"># Create a new container</span>
<span class="w">    </span><span class="c1"># Add it to the host network and mounting the connection_path</span>
<span class="w">    </span>docker<span class="w"> </span>create<span class="w"> </span>--name<span class="o">=</span><span class="nv">$container_name</span><span class="w"> </span>-v<span class="w">  </span><span class="nv">$connection_path</span>:/connections<span class="w"> </span>--network<span class="o">=</span>host<span class="w">  </span><span class="nv">$image_name</span>
<span class="w">    </span><span class="c1"># Start this server instance</span>
<span class="w">    </span>docker<span class="w"> </span>start<span class="w">  </span><span class="nv">$container_name</span>
<span class="k">fi</span>

<span class="c1"># Launch a ipykernel using the connection file that was passed as arg 1</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w">  </span><span class="nv">$container_name</span><span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>ipykernel_launcher<span class="w"> </span>-f<span class="w"> </span>/connections/<span class="nv">$connection_file</span>
</code></pre></div></p>
<p>We can then make this executable with:
<div class="highlight"><pre><span></span><code>chmod +x launch_docker.sh
</code></pre></div></p>
<p>Finally, we can modify the <code>kernel.json</code> file to call this script:
<div class="highlight"><pre><span></span><code>{
 &quot;argv&quot;: [
     &quot;/path/to/launch_docker.sh&quot;,
     &quot;{connection_file}&quot;
 ],
 &quot;display_name&quot;: &quot;custom-kernel (docker)&quot;,
 &quot;language&quot;: &quot;python&quot;,
 &quot;metadata&quot;: {
  &quot;debugger&quot;: true
 }
}
</code></pre></div></p>
<p>With this new <code>kernel.json</code> file and <code>launch_docker.sh</code> in place, we can now relaunch <code>jupyter lab</code> and open multiple notebooks. 
If we now check the containers that we have running with <code>docker ps</code>:
<div class="highlight"><pre><span></span><code>CONTAINER ID   IMAGE                     COMMAND                  CREATED          STATUS          PORTS                                         NAMES
e2a7475eb14f   obriens/kernel:latest        &quot;/build/keep_alive.sh&quot;   15 minutes ago   Up 15 minutes                                                 server
</code></pre></div>
We can see that only one kernel is running.</p>
<p>The container can be stopped at any time with:
<div class="highlight"><pre><span></span><code>docker stop server
</code></pre></div>
And removed with:
<div class="highlight"><pre><span></span><code>docker rm server
</code></pre></div></p>
<p>One downside is that we'll need to manually stop the container once we're finished.</p>
<h4 id="what-about-apptainer">What about Apptainer</h4>
<p>Similarly, we can limit the number of Apptainer containers by starting our container as an <code>instance</code> and then connecting to that instance.
Apptainer doesn't require a daemon script (like <code>/build/keep_alive.sh</code>), so we don't need to modify the image.
Let's use the following script to launch the Apptainer instance:
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="c1"># Get the filename of the connection file</span>
<span class="nv">connection_file</span><span class="o">=</span><span class="k">$(</span>basename<span class="w"> </span><span class="nv">$1</span><span class="k">)</span>
<span class="nv">container_name</span><span class="o">=</span><span class="s2">&quot;server&quot;</span>
<span class="nv">image_name</span><span class="o">=</span><span class="s2">&quot;/path/to/kernel.sif&quot;</span>
<span class="c1"># Check if the server instance is currently running</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="k">$(</span>apptainer<span class="w"> </span>instance<span class="w"> </span>list<span class="w"> </span><span class="nv">$container_name</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span><span class="w"> </span>-ge<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Server is running&quot;</span>
<span class="k">else</span>
<span class="w">    </span><span class="c1"># if it isn&#39;t start an instance</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Starting the server&quot;</span>
<span class="w">    </span><span class="c1"># Bind the runtime-dir (where the connection files are) to /connections within the container</span>
<span class="w">    </span>apptainer<span class="w"> </span>instance<span class="w"> </span>start<span class="w"> </span>--bind<span class="w"> </span><span class="sb">`</span>jupyter<span class="w"> </span>--runtime-dir<span class="sb">`</span>:/connections<span class="w"> </span><span class="nv">$image_name</span><span class="w"> </span><span class="nv">$container_name</span>
<span class="k">fi</span>

<span class="c1"># Attach and run ipykernel_laucher</span>
apptainer<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>instance://<span class="nv">$container_name</span><span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>ipykernel_launcher<span class="w"> </span>-f<span class="w"> </span>/connections/<span class="nv">$connection_file</span>
</code></pre></div></p>
<p>The instance can be stopped with
<div class="highlight"><pre><span></span><code>apptainer instance stop server 
</code></pre></div></p>
<h3 id="networking-and-port-mapping">Networking and Port mapping</h3>
<p>You might have noticed that we didn't need to pass any ports to the docker image. 
Instead, we simply add the container to the <code>host</code> network. 
In this set up, all the communication between the container and Jupyter lab is handled through the <code>host</code> network, with the Jupyter instance itself handling the ports being used.</p>
<p>In contrast to launching a Jupyter instance from within a container, we don't actually need to know what ports should be mapped within the container.
This greatly simplifies the setup, instead allowing ports to be determined at launch, without the need to reconfigure a run command of a docker-compose file.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; 2025 TSI <br> <a href="https://github.com/vuquangtrong/mkdocs-material-blog">Blog Theme</a> / <a href="https://squidfunk.github.io/mkdocs-material/">Material for MkDocs</a>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.indexes", "navigation.top", "toc.integrate", "header.autohide", "content.code.annotate", "content.code.copy"], "search": "../../assets/javascripts/workers/search.c011b7c0.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.7389ff0e.min.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>